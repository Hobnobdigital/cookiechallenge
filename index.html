<!-- ================= Cookie Challenge â€“ fast version (glitch fix) ================= -->
<!DOCTYPE html><html lang="en"><head>
<meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>Cookie Challenge</title>
<style>
html,body{margin:0;height:100%;background:#111;color:#fff;font-family:sans-serif;overflow:hidden}
#outer{display:flex;flex-direction:column;height:100%}
#hud{display:flex;justify-content:space-between;align-items:center;margin:4px 8px;font-size:18px}
#canvasWrap{flex:1;display:flex;justify-content:center;align-items:center}
#gameCanvas{background:#000;border:4px solid #fff;touch-action:none;max-width:98vw;max-height:65vh}

/* title */
#titleScreen{position:fixed;inset:0;background:url('title.png') center/cover no-repeat;
display:flex;flex-direction:column;justify-content:center;align-items:center}
#titleScreen h1{font-size:9vw;margin:0;text-shadow:0 0 10px #000}
#titleScreen button{padding:10px 26px;font-size:5vw;border:none;border-radius:8px;background:#d69c4e;color:#111;cursor:pointer}

/* misc */
#muteBtn{position:fixed;top:10px;right:10px;z-index:10;font-size:18px;padding:6px 10px;border:none;border-radius:4px;background:#d69c4e;color:#111}

/* D-pad */
#controls{position:fixed;bottom:12px;left:50%;transform:translateX(-50%);z-index:9;width:210px;height:170px}
.btn{position:absolute;width:70px;height:70px;border-radius:50%;background:rgba(255,255,255,.25);border:2px solid #fff;display:flex;justify-content:center;align-items:center;user-select:none;transition:.05s}
.btn:active{background:#fff;color:#000;transform:scale(.94)}
#up{top:0;left:70px}#down{bottom:0;left:70px}#left{left:0;top:50%;transform:translateY(-50%)}#right{right:0;top:50%;transform:translateY(-50%)}
.btn span{font-size:32px;pointer-events:none}
@media(pointer:fine){#controls{display:none}}
</style></head><body>
<div id="outer">
  <div id="hud" style="display:none"><span id="score">Score: 0</span><span id="level">Level 1</span></div>
  <div id="canvasWrap"><canvas id="gameCanvas"></canvas></div>
</div>

<div id="titleScreen"><h1>Cookie Challenge</h1><button id="startBtn">Start Game</button></div>

<div id="controls">
  <div id="up"    class="btn"><span>â–²</span></div>
  <div id="down"  class="btn"><span>â–¼</span></div>
  <div id="left"  class="btn"><span>â—€</span></div>
  <div id="right" class="btn"><span>â–¶</span></div>
</div>

<button id="muteBtn">ðŸ”Š</button>
<audio id="bgm" src="bgm.mp3" loop></audio>

<script>
/* ==== constants ==== */
const PLAYER_SPEED=5, MONSTER_R=22, BULLET_R=5,
      COOKIE_R=6, OREO_R=14, BOOST_R=10,
      SHOOT_TIME=10e3, BOOST_TIME=10e3;

/* ==== DOM ==== */
const $ = s => document.querySelector(s);
const cvs=$('#gameCanvas'),ctx=cvs.getContext('2d'),
      hud=$('#hud'),scoreEl=$('#score'),lvlEl=$('#level'),
      title=$('#titleScreen'),start=$('#startBtn'),mute=$('#muteBtn'),
      bgm=$('#bgm'),mobile=matchMedia('(pointer:coarse)').matches;

/* ==== resize ==== */
function fit(){const w=innerWidth-24,h=(innerHeight-(mobile?220:60))-24;cvs.width=w;cvs.height=h;}
addEventListener('resize',fit);fit();

/* ==== D-pad ==== */
const dirs={up:0,down:0,left:0,right:0};
['up','down','left','right'].forEach(id=>{
 ['touchstart','mousedown'].forEach(ev=>idEl(id).addEventListener(ev,e=>{e.preventDefault();dirs[id]=1}));
 ['touchend','touchcancel','mouseup','mouseleave'].forEach(ev=>idEl(id).addEventListener(ev,e=>{e.preventDefault();dirs[id]=0}));
});
function idEl(id){return document.getElementById(id)}

/* ==== audio helpers ==== */
const AC=AudioContext||webkitAudioContext,ac=new AC();
const osc=(f,d=120,t='square',v=.4)=>{const o=ac.createOscillator(),g=ac.createGain();o.type=t;o.frequency.value=f;g.gain.value=v;o.connect(g).connect(ac.destination);o.start();o.stop(ac.currentTime+d/1e3);}
const eatSfx =()=>[932,1175,1397].forEach((f,i)=>setTimeout(()=>osc(f,90,'square',.35),i*30));
const powerSfx=()=>[784,932,1046,1175].forEach((f,i)=>setTimeout(()=>osc(f,120,'triangle',.45),i*90));
const boomSfx =()=>[330,196,98].forEach((f,i)=>setTimeout(()=>osc(f,180,'sawtooth',.5),i*70));
const hitSfx =()=>osc(110,340,'square',.5);
const fireSfx=()=>osc(1568,60,'square',.45);

/* ==== helpers ==== */
const rand=()=>({x:20+Math.random()*(cvs.width-40),y:20+Math.random()*(cvs.height-40)});
const dist=(a,b)=>Math.hypot(a.x-b.x,a.y-b.y);

/* ==== game vars ==== */
let p,cookies,mons,playerBullets,monsterBullets,score,level,oreo,boost,
    shootTimer,boostTimer,gameOver,run,monSpeed;

/* ==== reset ==== */
function reset(){
 p={x:cvs.width/2,y:cvs.height/2,dx:0,dy:0,spd:PLAYER_SPEED,color:'#4ec5f1'};
 cookies=[];mons=[];playerBullets=[];monsterBullets=[];oreo=null;boost=null;
 score=0;level=1;monSpeed=3;shootTimer=0;boostTimer=0;gameOver=0;
 spawnCookies();spawnMonsters(5);
 scoreEl.textContent='Score: 0';lvlEl.textContent='Level 1';
}
function spawnCookies(){for(let i=0;i<25;i++)cookies.push(rand());}
function spawnMonsters(n){
 for(let i=0;i<n;i++){let m=rand(),a=Math.random()*6.28;
  m.dx=Math.cos(a)*monSpeed;m.dy=Math.sin(a)*monSpeed;m.cool=1000+Math.random()*1000;m.tCool=m.cool;
  mons.push(m);}
}

/* ==== gameplay ==== */
function firePlayer(){if(shootTimer<=0)return;fireSfx();playerBullets.push({x:p.x,y:p.y,dx:0,dy:-10});}
function fireMonster(m){const a=Math.atan2(p.y-m.y,p.x-m.x);monsterBullets.push({x:m.x,y:m.y,dx:Math.cos(a)*6,dy:Math.sin(a)*6});}
function touchDir(){if(!mobile)return;p.dx=(dirs.left?-p.spd:0)+(dirs.right?p.spd:0);p.dy=(dirs.up?-p.spd:0)+(dirs.down?p.spd:0);}

function update(dt){
 touchDir();
 p.x=Math.max(PLAYER_SPEED,Math.min(cvs.width-PLAYER_SPEED,p.x+p.dx));
 p.y=Math.max(PLAYER_SPEED,Math.min(cvs.height-PLAYER_SPEED,p.y+p.dy));

 if(shootTimer>0){shootTimer-=dt;if(shootTimer<=0)p.color='#4ec5f1';}
 if(boostTimer>0){boostTimer-=dt;if(boostTimer<=0){p.spd=PLAYER_SPEED;p.color='#4ec5f1';}}

 playerBullets.forEach(b=>{b.y+=b.dy});
 monsterBullets.forEach(b=>{b.x+=b.dx;b.y+=b.dy});
 playerBullets=playerBullets.filter(b=>b.y>-BULLET_R);
 monsterBullets=monsterBullets.filter(b=>b.x>-BULLET_R&&b.x<cvs.width+BULLET_R&&b.y>-BULLET_R&&b.y<cvs.height+BULLET_R);

 mons.forEach(m=>{
  m.x+=m.dx;m.y+=m.dy;
  if(m.x<MONSTER_R||m.x>cvs.width-MONSTER_R)m.dx*=-1;
  if(m.y<MONSTER_R||m.y>cvs.height-MONSTER_R)m.dy*=-1;
  m.tCool-=dt;if(m.tCool<=0){fireMonster(m);m.tCool=m.cool;}
 });

 cookies=cookies.filter(c=>{
  if(dist(c,p)<PLAYER_SPEED+COOKIE_R){score+=10;scoreEl.textContent='Score: '+score;eatSfx();return 0}
  return 1;
 });

 if(!oreo && cookies.length<=20)oreo=rand();
 if(!boost&& cookies.length<=10)boost=rand();

 if(oreo&&dist(oreo,p)<PLAYER_SPEED+OREO_R){oreo=null;shootTimer=SHOOT_TIME;p.color='#ffd700';powerSfx();}
 if(boost&&dist(boost,p)<PLAYER_SPEED+BOOST_R){boost=null;boostTimer=BOOST_TIME;p.spd=PLAYER_SPEED*2.5;p.color='#00e0ff';powerSfx();}

 mons=mons.filter(m=>{
  const hit=playerBullets.some(b=>dist(b,m)<MONSTER_R+BULLET_R);
  if(hit){boomSfx();score+=50;scoreEl.textContent='Score: '+score;}
  return !hit;
 });
 playerBullets=playerBullets.filter(b=>!mons.some(m=>dist(b,m)<MONSTER_R+BULLET_R));

 if(monsterBullets.some(b=>dist(b,p)<PLAYER_SPEED+BULLET_R)){gameOver=1;run=0;hitSfx();bgm.pause();}

 if(!cookies.length && !gameOver){
  level++;lvlEl.textContent='Level '+level;monSpeed+=0.3;
  spawnCookies();spawnMonsters(3+level*2);shootTimer=0;boostTimer=0;oreo=null;boost=null;powerSfx();
 }
}

let last=0;
function loop(t){if(!run)return;const dt=t-last;last=t;update(dt);draw();requestAnimationFrame(loop);}

/* ==== render ==== */
function circ(x,y,r,c){ctx.fillStyle=c;ctx.beginPath();ctx.arc(x,y,r,0,6.28);ctx.fill();}
function draw(){
 ctx.fillStyle='#000';ctx.fillRect(0,0,cvs.width,cvs.height);

 cookies.forEach(c=>{circ(c.x,c.y,COOKIE_R,'#d69c4e');circ(c.x-2,c.y-1,2,'#925c27');circ(c.x+2,c.y+1,2,'#925c27');});
 if(oreo){circ(oreo.x,oreo.y,OREO_R+3,'#fff');circ(oreo.x,oreo.y,OREO_R,'#3d2b1f');}
 if(boost){circ(boost.x,boost.y,BOOST_R,'#00e0ff');}

 playerBullets.forEach(b=>circ(b.x,b.y,BULLET_R,'#d69c4e'));
 monsterBullets.forEach(b=>circ(b.x,b.y,BULLET_R,'#3d2b1f'));

 circ(p.x,p.y,PLAYER_SPEED,p.color);

 mons.forEach(m=>{
  circ(m.x,m.y,MONSTER_R,level<2?'#e63946':level<3?'#8b5cf6':'#22c55e');
  circ(m.x-MONSTER_R/3,m.y-MONSTER_R/3,MONSTER_R/3,'#fff');
  circ(m.x+MONSTER_R/3,m.y-MONSTER_R/3,MONSTER_R/3,'#fff');
  circ(m.x-MONSTER_R/3,m.y-MONSTER_R/3,MONSTER_R/6,'#000');
  circ(m.x+MONSTER_R/3,m.y-MONSTER_R/3,MONSTER_R/6,'#000');
 });

 if(gameOver){
  ctx.fillStyle='rgba(0,0,0,.75)';ctx.fillRect(0,0,cvs.width,cvs.height);
  ctx.fillStyle='#fff';ctx.textAlign='center';ctx.font='8vw sans-serif';
  ctx.fillText('Game Over',cvs.width/2,cvs.height/2-20);
  ctx.font='4vw sans-serif';ctx.fillText('Press R or tap Start',cvs.width/2,cvs.height/2+20);
 }
}

/* ==== controls ==== */
start.onclick=()=>{                     /* --- FIX: fit() BEFORE reset() --- */
  title.style.display='none';
  hud.style.display='flex';
  fit();                                // <- ensures canvas uses final height
  reset();
  run=1;bgm.volume=.65;bgm.play();ac.resume();last=performance.now();loop(last);
};
addEventListener('keydown',e=>{
 if(!run&&e.key!=='r')start.click();
 if(gameOver&&e.key==='r'){start.click();return;}
 if(e.key===' ')firePlayer();
 if(e.key==='ArrowUp'||e.key==='w')p.dy=-p.spd;
 if(e.key==='ArrowDown'||e.key==='s')p.dy=p.spd;
 if(e.key==='ArrowLeft'||e.key==='a')p.dx=-p.spd;
 if(e.key==='ArrowRight'||e.key==='d')p.dx=p.spd;
});
addEventListener('keyup',e=>{
 if(['ArrowUp','w','ArrowDown','s'].includes(e.key))p.dy=0;
 if(['ArrowLeft','a','Right','d','ArrowRight'].includes(e.key))p.dx=0;
});
cvs.addEventListener('mousedown',firePlayer);
cvs.addEventListener('touchstart',e=>{if(mobile)firePlayer();});
mute.onclick=()=>{bgm.muted=!bgm.muted;mute.textContent=bgm.muted?'ðŸ”‡':'ðŸ”Š';};
</script>
</body></html>
