<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Cookie Challenge</title>

<style>
/* -------- general layout -------- */
html,body{margin:0;height:100%;background:#111;color:#fff;font-family:sans-serif;overflow:hidden}
#outer{display:flex;flex-direction:column;height:100%}
#hud{display:flex;justify-content:space-between;align-items:center;margin:4px 8px;font-size:18px}
#canvasWrap{flex:1;display:flex;justify-content:center;align-items:center}
#gameCanvas{background:#000;border:4px solid #fff;touch-action:none;max-width:98vw;max-height:65vh}

/* -------- title screen -------- */
#titleScreen{position:fixed;inset:0;background:url('title.png') center/cover no-repeat;
display:flex;flex-direction:column;justify-content:center;align-items:center}
#titleScreen h1{font-size:9vw;margin:0;text-shadow:0 0 10px #000}
#titleScreen button{padding:10px 26px;font-size:5vw;border:none;border-radius:8px;background:#d69c4e;color:#111}

/* -------- mute -------- */
#muteBtn{position:fixed;top:10px;right:10px;z-index:10;font-size:18px;padding:6px 10px;border:none;border-radius:4px;background:#d69c4e;color:#111}

/* -------- on-screen D-pad -------- */
#controls{position:fixed;bottom:12px;left:50%;transform:translateX(-50%);z-index:9;width:210px;height:170px}
.btn{position:absolute;width:70px;height:70px;border-radius:50%;background:rgba(255,255,255,.25);border:2px solid #fff;display:flex;justify-content:center;align-items:center;user-select:none;transition:.05s}
.btn:active{background:#fff;color:#000;transform:scale(.94)}
#up{top:0;left:70px}
#down{bottom:0;left:70px}
#left{left:0;top:50%;transform:translateY(-50%)}
#right{right:0;top:50%;transform:translateY(-50%)}
.btn span{font-size:32px;pointer-events:none}
@media(pointer:fine){#controls{display:none}}
</style>
</head>
<body>
<div id="outer">
  <div id="hud" style="display:none">
    <span id="score">Score: 0</span>
    <span id="level">Level 1</span>
  </div>
  <div id="canvasWrap"><canvas id="gameCanvas"></canvas></div>
</div>

<!-- title -->
<div id="titleScreen"><h1>Cookie Challenge</h1><button id="startBtn">Start Game</button></div>

<!-- D-pad -->
<div id="controls">
  <div id="up"    class="btn"><span>â–²</span></div>
  <div id="down"  class="btn"><span>â–¼</span></div>
  <div id="left"  class="btn"><span>â—€</span></div>
  <div id="right" class="btn"><span>â–¶</span></div>
</div>

<button id="muteBtn">ðŸ”Š</button>
<audio id="bgm" src="bgm.mp3" loop></audio>

<script>
/* ========== constants ========== */
const PS=4, BASE_MS=2, CR=6, BASE_MR=12, PR=10, OREO_R=12, BULLET_R=4;
const OREO_INTERVAL=15000, SHOOT_TIME=10000;

/* ========== DOM shortcuts ========== */
const cvs=q('#gameCanvas'),ctx=cvs.getContext('2d'),
      hud=q('#hud'),scoreEl=q('#score'),levelEl=q('#level'),
      title=q('#titleScreen'),start=q('#startBtn'),mute=q('#muteBtn'),
      bgm=q('#bgm'),mobile=matchMedia('(pointer:coarse)').matches;
function q(sel){return document.querySelector(sel);}

/* ========== dynamic resize ========== */
function size(){const w=innerWidth-24,h=(innerHeight-(mobile?220:60))-24;cvs.width=w;cvs.height=h;}
addEventListener('resize',size);size();

/* ========== D-pad state ========== */
const dirs={up:0,down:0,left:0,right:0};
['up','down','left','right'].forEach(id=>{
 ['touchstart','mousedown'].forEach(e=>g(id).addEventListener(e,a=>{a.preventDefault();dirs[id]=1}));
 ['touchend','touchcancel','mouseup','mouseleave'].forEach(e=>g(id).addEventListener(e,a=>{a.preventDefault();dirs[id]=0}));
});
function g(id){return document.getElementById(id)}

/* ========== Web-Audio SFX ========== */
const AC=AudioContext||webkitAudioContext,ac=new AC();
function tone(f,d=120,tp='square',v=.4){const o=ac.createOscillator(),g=ac.createGain();o.type=tp;o.frequency.value=f;g.gain.value=v;o.connect(g).connect(ac.destination);o.start();o.stop(ac.currentTime+d/1e3);}
const eatSfx=()=>[932,1175,1397].forEach((f,i)=>setTimeout(()=>tone(f,90,'square',.35),i*30));
const oreoSfx=()=>[523,659,784,1046].forEach((f,i)=>setTimeout(()=>tone(f,140,'triangle',.45),i*120));
const hitSfx =()=>tone(110,340,'square',.5);
const bulletSfx=()=>tone(1568,60,'square',.4);

/* ========== helpers ========== */
const rand=()=>({x:Math.random()*(cvs.width-40)+20,y:Math.random()*(cvs.height-40)+20});
const dist=(a,b)=>Math.hypot(a.x-b.x,a.y-b.y);

/* ========== game vars ========== */
let p,cookies,mons,oreo,bullets,score,level,speedFactor,ms,gameOver,run,shooting,oreoTimer;

/* ========== reset ========== */
function reset(){
 p={x:cvs.width/2,y:cvs.height/2,dx:0,dy:0,color:'#4ec5f1'};
 cookies=[];mons=[];bullets=[];oreo=null;score=0;level=1;speedFactor=1;ms=BASE_MS;gameOver=0;shooting=0;
 spawnCookies();spawnMonsters(3);
 scoreEl.textContent='Score: 0';levelEl.textContent='Level 1';
 clearInterval(oreoTimer);oreoTimer=setInterval(spawnOreo,OREO_INTERVAL);
}

function spawnCookies(){for(let i=0;i<20;i++)cookies.push(rand());}

function spawnMonsters(n){
 for(let i=0;i<n;i++){
   let m=rand(),a=Math.random()*Math.PI*2;
   m.dx=Math.cos(a)*ms;m.dy=Math.sin(a)*ms;
   m.r=BASE_MR+(level-1)*5;
   m.type=level;          // 1=red blob, 2=purple, 3+=green spike
   mons.push(m);
 }
}

function spawnOreo(){oreo=rand();oreo.r=OREO_R;}

function touchDir(){if(!mobile)return;p.dx=(dirs.left?-PS:0)+(dirs.right?PS:0);p.dy=(dirs.up?-PS:0)+(dirs.down?PS:0);}

function update(){
 touchDir();
 /* player movement / bounds */
 p.x=Math.max(PR,Math.min(cvs.width-PR,p.x+p.dx));p.y=Math.max(PR,Math.min(cvs.height-PR,p.y+p.dy));

 /* bullets */
 bullets=bullets.filter(b=>{b.x+=b.dx;b.y+=b.dy;return b.x>-BULLET_R&&b.x<cvs.width+BULLET_R&&b.y>-BULLET_R&&b.y<cvs.height+BULLET_R;});

 /* monster move */
 mons.forEach(m=>{m.x+=m.dx;m.y+=m.dy;if(m.x<m.r||m.x>cvs.width-m.r)m.dx*=-1;if(m.y<m.r||m.y>cvs.height-m.r)m.dy*=-1});

 /* eat cookies */
 cookies=cookies.filter(c=>{if(dist(c,p)<PR+CR){score+=10;scoreEl.textContent='Score: '+score;eatSfx();return 0}return 1});

 /* pick up oreo */
 if(oreo && dist(oreo,p)<PR+OREO_R){oreo=null;shooting=SHOOT_TIME;oreoSfx();p.color='#ffd700';}

 /* shooting timer */
 if(shooting>0){shooting-=16;if(shooting<=0)p.color='#4ec5f1';}

 /* bullets hit monsters */
 bullets=bullets.filter(b=>{
   let hit=false;
   mons=mons.filter(m=>{
     if(dist(b,m)<m.r+BULLET_R){score+=50;scoreEl.textContent='Score: '+score;hit=true;return 0}
     return 1;
   });
   return !hit;
 });

 /* player hit */
 if(!shooting && mons.some(m=>dist(m,p)<m.r+PR)){gameOver=1;run=0;hitSfx();bgm.pause();}

 /* new level */
 if(!cookies.length){level++;speedFactor+=.2;ms=BASE_MS*speedFactor;levelEl.textContent='Level '+level;
   spawnCookies();spawnMonsters(1);oreoSfx();} /* reuse fanfare */
}

function draw(){
 ctx.fillStyle='#000';ctx.fillRect(0,0,cvs.width,cvs.height);

 /* cookies */
 cookies.forEach(c=>{ctx.fillStyle='#d69c4e';ctx.beginPath();ctx.arc(c.x,c.y,CR,0,6.28);ctx.fill();
 ctx.fillStyle='#925c27';ctx.beginPath();ctx.arc(c.x-2,c.y-1,2,0,6.28);ctx.fill();ctx.beginPath();ctx.arc(c.x+2,c.y+1,2,0,6.28);ctx.fill();});

 /* oreo */
 if(oreo){ctx.fillStyle='#fff';ctx.beginPath();ctx.arc(oreo.x,oreo.y,OREO_R+2,0,6.28);ctx.fill();
          ctx.fillStyle='#3d2b1f';ctx.beginPath();ctx.arc(oreo.x,oreo.y,OREO_R,0,6.28);ctx.fill();}

 /* bullets */
 ctx.fillStyle='#0bf';
 bullets.forEach(b=>{ctx.beginPath();ctx.arc(b.x,b.y,BULLET_R,0,6.28);ctx.fill();});

 /* player */
 ctx.fillStyle=p.color;ctx.beginPath();ctx.arc(p.x,p.y,PR,0,6.28);ctx.fill();

 /* monsters */
 mons.forEach(m=>{
   ctx.fillStyle=m.type===1?'#e63946':m.type===2?'#8b5cf6':'#22c55e';
   ctx.beginPath();ctx.arc(m.x,m.y,m.r,0,6.28);ctx.fill();
   ctx.fillStyle='#fff';ctx.beginPath();ctx.arc(m.x-m.r/3,m.y-m.r/3,Math.max(3,m.r/4),0,6.28);ctx.fill();
   ctx.beginPath();ctx.arc(m.x+m.r/3,m.y-m.r/3,Math.max(3,m.r/4),0,6.28);ctx.fill();
   ctx.fillStyle='#000';ctx.beginPath();ctx.arc(m.x-m.r/3,m.y-m.r/3,Math.max(1.5,m.r/6),0,6.28);ctx.fill();
   ctx.beginPath();ctx.arc(m.x+m.r/3,m.y-m.r/3,Math.max(1.5,m.r/6),0,6.28);ctx.fill();
 });

 if(gameOver){
   ctx.fillStyle='rgba(0,0,0,.75)';ctx.fillRect(0,0,cvs.width,cvs.height);
   ctx.fillStyle='#fff';ctx.textAlign='center';ctx.font='8vw sans-serif';
   ctx.fillText('Game Over',cvs.width/2,cvs.height/2-20);
   ctx.font='4vw sans-serif';ctx.fillText('Press R or tap Start',cvs.width/2,cvs.height/2+20);
 }
}

function loop(){if(!run)return;update();draw();requestAnimationFrame(loop);}

/* ========== controls ========== */
start.onclick=()=>{title.style.display='none';hud.style.display='flex';reset();run=1;bgm.volume=.65;bgm.play();ac.resume();loop();};

addEventListener('keydown',e=>{
 if(!run&&e.key!=='r')start.click();
 if(gameOver&&e.key==='r'){start.click();return;}
 if(e.key===' '&&shooting>0){shoot();}       // space to fire
 if(e.key==='ArrowUp'||e.key==='w')p.dy=-PS;
 if(e.key==='ArrowDown'||e.key==='s')p.dy=PS;
 if(e.key==='ArrowLeft'||e.key==='a')p.dx=-PS;
 if(e.key==='ArrowRight'||e.key==='d')p.dx=PS;
});

addEventListener('keyup',e=>{
 if(['ArrowUp','w','ArrowDown','s'].includes(e.key))p.dy=0;
 if(['ArrowLeft','a','ArrowRight','d'].includes(e.key))p.dx=0;
});

/* tap to shoot on mobile / mouse */
cvs.addEventListener('mousedown',()=>shoot());
cvs.addEventListener('touchstart',e=>{if(mobile)shoot();});

function shoot(){if(shooting<=0)return;bulletSfx();
 bullets.push({x:p.x,y:p.y,dx:0,dy:-8});}

mute.onclick=()=>{bgm.muted=!bgm.muted;mute.textContent=bgm.muted?'ðŸ”‡':'ðŸ”Š';};
</script>
</body>
</html>
